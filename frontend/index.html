<!DOCTYPE html>
<html>
  <head>
    <title>File Listing</title>
    <link rel="stylesheet" href="styles.css" />
    <style>
      .navbar {
        padding: 20px;
      }
      .file-input {
        width: 300px !important;
      }
      .user-input {
        width: 300px !important;
      }
    </style>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
  </head>

  <body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <a class="navbar-brand mx-2">PDF Organizer</a>
      <input
        class="form-control user-input"
        type="text"
        id="userId"
        placeholder="Enter User ID"
      />
      <button id="fetchFiles" class="btn btn-outline-primary mx-1">
        Fetch Files
      </button>
      <button id="uploadTrigger" class="btn btn-primary mx-1">Upload</button>
      <input
        class="form-control mx-2 file-input"
        type="file"
        id="uploadFiles"
        name="filename"
      />
    </nav>
    <div class="workbench">
      <div class="files displayHalf left" id="fileList"></div>
      <div class="fileInfo displayHalf right" id="fileInfo">
        <h2>Filename:</h2>
        <p id="file-name">Filename</p>
        <h2>Content:</h2>
        <p id="file-content">Content</p>
      </div>
    </div>
    <button id="testTrigger">(TEST) replace content</button>

    <script>
      const fetchFilesButton = document.getElementById("fetchFiles");
      const uploadFilesButton = document.getElementById("uploadFiles");
      const uploadTriggerButton = document.getElementById("uploadTrigger");
      const userIdInput = document.getElementById("userId");
      const fileListDiv = document.getElementById("fileList");
      const testButton = document.getElementById("testTrigger");

      testButton.addEventListener("click", async () => {
        console.log("working");
        let filename = "test";
        try {
          await fetch(
            `http://localhost:3000/info/${encodeURIComponent(filename)}`
          )
            .then((response) => {
              return response.json();
            })
            .then((data) => {
              let fileNameField = document.getElementById("file-name");
              let contentField = document.getElementById("file-content");
              fileNameField.innerHTML = data.fileName;
              contentField.innerHTML = data.content;
            });
        } catch (err) {
          console.log(err);
          console.error("Error fetching files:", error);
        }
      });

      createImage = (userId, filename) => {
        return `<img src="../images/${encodeURIComponent(
          userId
        )}/${filename}.1.png" alt="Image of ${filename}">`;
      };

      fetchFilesButton.addEventListener("click", async () => {
        const userId = userIdInput.value.trim(); // Trim to remove any leading/trailing whitespace

        try {
          const response = await fetch(
            `http://localhost:3000/uploads/${encodeURIComponent(userId)}`
          );
          if (!response.ok) throw new Error("Network response was not ok.");

          const filesResponse = await response.json();
          const files = filesResponse.userFiles;

          console.log(files);

          fileListDiv.innerHTML = "";

          // logs errors if the server responds with a string (in case of zero files)
          if (files.length > 0 && typeof files !== "string") {
            const containerDiv = document.createElement("div");
            containerDiv.classList.add("file-list-container");

            console.log(typeof files);

            files.forEach((filename) => {
              const fileDiv = document.createElement("div");
              fileDiv.classList.add("file-item");
              containerDiv.setAttribute("id", filename);

              const p = document.createElement("p");
              p.textContent = filename;
              fileDiv.appendChild(p);

              let img = document.createElement("div");
              img.innerHTML = createImage(userId, filename);
              containerDiv.appendChild(img);

              fileDiv.appendChild(img);
              containerDiv.appendChild(fileDiv);
            });

            fileListDiv.appendChild(containerDiv);
          } else {
            fileListDiv.textContent = "No files found for this user.";
          }
        } catch (error) {
          console.error("Error fetching files:", error);
          fileListDiv.textContent = "Error fetching files";
        }
      });

      uploadTriggerButton.addEventListener("click", async () => {
        let file = uploadFilesButton.files[0];
        const userId = userIdInput.value.trim();

        if (file) {
          var formData = new FormData();
          formData.append("file", file);

          try {
            const response = await fetch(
              `http://localhost:3000/upload/${encodeURIComponent(userId)}`,
              {
                method: "POST",
                body: formData,
              }
            );

            if (response.ok) {
              console.log("File uploaded successfully");
            } else {
              console.error("Error uploading file:", response.statusText);
            }
          } catch (error) {
            console.error("Error uploading file:", error);
          }
        } else {
          console.error("No file selected");
        }
      });

      // TODO: WORK MORE ON THIS
      document
        .getElementById("fileList")
        .addEventListener("click", function (event) {
          // Check if the clicked element has the class "file-item"
          if (event.target.classList.contains("file-item")) {
            // Handle the click event here
            console.log("Clicked:", event.target.textContent); // Example: Logging the text content of the clicked div
          }
        });

      // LEFT fileList
      // RIGHT fileInfo

      function checkJWT() {
        // TODO: add JWT to login
        // const token = localStorage.getItem("jwt_token");
        const token = true;
        if (!token) window.location.href = "login.html";
      }

      window.onload = checkJWT;
    </script>
  </body>
</html>
